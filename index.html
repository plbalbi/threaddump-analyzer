<!DOCTYPE html>
<!--
   Copyright 2014 Spotify AB

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
-->
<html>

  <head>
    <title>Online Java Thread Dump Analyzer</title>
    <link rel="stylesheet" type="text/css" href="stylesheet.css"/>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  </head>

  <body>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="analyze.js" type="text/javascript"></script>
    <p>
      <textarea cols="115" rows="3" id="threadRegexFilter" autofocus></textarea>
      <br/>
      <input type="submit" value="Analyze" onclick="analyzeTextfield();">
      <input type="submit" value="Clear" onclick="clearTextfield();">
      <input type="submit" value="Filter" onclick="filterThreads();">
      <input type="file" value="Analyze file" id="FILE" onchange="analyzeFile();">
    </p>

    <div id="RUNNING_DIV" style="display: none;">
      <hr/>
      <h2 id="RUNNING_HEADER">Top Running Methods</h2>
      <table id="RUNNING"
             summary="Top methods from all threads that are running">
      </table>
    </div>

    <div id="OUTPUT_DIV" style="display: none;">
      <hr/>
      <div id="OUTPUT"></div>
      <p><a href="https://github.com/spotify/threaddump-analyzer/issues/new">Report a bug</a></p>
    </div>

    <div id="SYNCHRONIZERS_DIV" style="display: none;">
      <hr/>
      <h2 id="SYNCHRONIZERS_HEADER">Synchronizers</h2>
      <table id="SYNCHRONIZERS"
             summary="A list of all synchronizers in the thread dump">
      </table>
      <p><a href="https://github.com/spotify/threaddump-analyzer/issues/new">Report a bug</a></p>
    </div>

    <div id="IGNORED_DIV" style="display: none;">
      <hr/>
      <h2>Ignored Input Lines</h2>
      <p><a href="https://github.com/spotify/threaddump-analyzer/blob/gh-pages/README.md#todo">
          See TODO list for which of these there are plans for already:</a></p>
      <table id="IGNORED" class="ignored"
             summary="Lines that were ignored while parsing the thread dump">
      </table>
      <p><a href="https://github.com/spotify/threaddump-analyzer/issues/new">Report a bug</a></p>
    </div>

    <hr/>
    <p><a href="http://github.com/spotify/threaddump-analyzer">
        Source code on Github</a></p>
    <p><a href="https://github.com/spotify/threaddump-analyzer/blob/gh-pages/README.md#todo">
        TODO list on Github</a></p>
    <p><a href="test.html">
        Run the test suite in your browser</a></p>

    <script type="text/javascript">

      var currentThreadFilter = null
      var lastNonMatchingThreads = []

      const getThreadDivId = (tid) => "thread-" + tid

      filterThreads = () => {

        lastNonMatchingThreads.forEach(tidNotMatching => {
          d3.select(d3.select("#" + getThreadDivId(tidNotMatching)).node().parentNode).style("display","block")
        })

        currentThreadFilter = new RegExp(document.getElementById("threadRegexFilter").value)
        lastNonMatchingThreads = currentAnalyzer.threads.filter(thread => !currentThreadFilter.test(thread.name)).map(thread => thread.tid)

        // Show only matching threadgroups
        lastNonMatchingThreads.forEach(tidNotMatching => {
          try{
            var divId = "#" + getThreadDivId(tidNotMatching)
            var threadGroupNode = d3.select(divId).node().parentNode
            if (threadGroupNode) {
              d3.select(threadGroupNode).style("display","none")
            }
          } catch(err) {
            console.error("Did not find thread-div-element with tid: " + tidNotMatching)
          }
        })
      }

      document.getElementById("threadRegexFilter").onchange = filterThreads
      document.getElementById("threadRegexFilter").onkeyup = filterThreads

      // Default listeners
      d3.select("#RUNNING_HEADER").on("click", ()=>{
        var currentStyle = d3.select("table#RUNNING").style("display")
        // By default check if it's not displayed
        if (currentStyle == "none") {
          d3.select("table#RUNNING").style("display","block")
        } else {
          d3.select("table#RUNNING").style("display","none")
        }
      })
    </script>
  </body>
</html>
